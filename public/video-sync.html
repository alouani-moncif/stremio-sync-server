<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Video Sync</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    #roleDisplay { font-size: 22px; font-weight: bold; margin-bottom: 15px; }
    #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 250px; overflow-y: auto; }
    video { width: 100%; max-width: 720px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div id="roleDisplay"></div>

  <video id="video" controls>
    <source src="sample.mp4" type="video/mp4">
    Your browser does not support HTML5 video.
  </video>

  <h3>Log</h3>
  <div id="log"></div>

<script>
const SERVER_URL = "wss://stremio-sync-server-production.up.railway.app";

// Determine role from URL
const url = new URL(window.location.href);
const role = url.searchParams.get("role") === "master" ? "master" : "slave";

document.getElementById("roleDisplay").innerText =
  role === "master" ? "ROLE: MASTER" : "ROLE: SLAVE";

const video = document.getElementById("video");

// --- WebSocket setup ---
const ws = new WebSocket(SERVER_URL);
ws.binaryType = "blob"; // still safe to convert to text

ws.onopen = () => {
  log("CONNECTED as " + role);
  ws.send(JSON.stringify({ role }));

  if(role === "master") {
      setupMasterEvents();
  }
};

ws.onmessage = async (event) => {
  let raw = event.data;
  if(raw instanceof Blob) raw = await raw.text();

  log("RAW MESSAGE: " + raw);

  let msg;
  try { msg = JSON.parse(raw); }
  catch { log("Invalid JSON: " + raw); return; }

  if(role === "master") return;

  // SLAVE reacts
  // Wait for video metadata
  if(video.readyState < 2){
      await new Promise(resolve => {
          video.onloadedmetadata = () => resolve();
      });
  }

  switch(msg.type){
      case "play": video.play().catch(e=>log("Play blocked:"+e)); break;
      case "pause": video.pause(); break;
      case "seek": 
          if(msg.value != null) video.currentTime = msg.value; 
          break;
  }

  log("SLAVE received: " + JSON.stringify(msg));
};

// --- Logging ---
function log(txt){
    const box = document.getElementById("log");
    box.innerText += txt + "\n";
    box.scrollTop = box.scrollHeight;
}

// --- MASTER events based on native video controls ---
function setupMasterEvents(){
    // Play / Pause
    video.addEventListener("play", () => sendCmd("play"));
    video.addEventListener("pause", () => sendCmd("pause"));

    // Seeked
    video.addEventListener("seeked", () => sendCmd("seek", video.currentTime));
}

// --- Send command to WS ---
function sendCmd(type, value=null){
    if(role !== "master") return;
    const msg = { type, value, ts: Date.now() };
    ws.send(JSON.stringify(msg));
    log("MASTER sent: " + JSON.stringify(msg));
}
</script>
</body>
</html>
